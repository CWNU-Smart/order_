<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.view-active { background-color: #4f46e5; color: white; }
        .tab-btn.collection-active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.7); } /* emerald-400 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card, .order-card { animation: fadeIn 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-gray-800">ì£¼ë¬¸ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-600 mt-2">ì¼ìë¥¼ ì„ íƒí•´ ì£¼ë¬¸ì„ ê´€ë¦¬í•˜ê³ , ìƒˆ ì¼ì°¨ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
        </header>

        <div id="day-tabs-container" class="mb-6 flex items-center justify-center flex-wrap gap-3">
            <!-- ì¼ì íƒ­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
        </div>

        <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6"></section>
        <main id="order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, deleteDoc, orderBy, getDocs, setDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyAWzxJrQROhzSnVJCmTEUDfpYn-TJqHbHQ",
  authDomain: "order-4f8a2.firebaseapp.com",
  projectId: "order-4f8a2",
  storageBucket: "order-4f8a2.firebasestorage.app",
  messagingSenderId: "69210404028",
  appId: "1:69210404028:web:25fe58abbcbff4d1e9ccb9",
  measurementId: "G-JBK15C76HS"
		};
        
        if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            // ... (Firebase ì„¤ì • ì˜¤ë¥˜ ì•ˆë‚´ HTML)
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DELETE_PASSWORD = "1234";

        let allOrders = [];
        let config = { dayTabs: [], activeDay: null };
        let viewingDay = 'all';
        const configRef = doc(db, "festivalConfig", "settings");

        const dayTabsContainer = document.getElementById('day-tabs-container');
        const summarySection = document.getElementById('summary-section');
        const orderList = document.getElementById('order-list');
        const modalContainer = document.getElementById('modal-container');

        const formatTimestamp = (ts, includeDate = false) => {
            if (!ts) return '';
            const options = includeDate 
                ? { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short', hour: '2-digit', minute: '2-digit' }
                : { hour: '2-digit', minute: '2-digit' };
            return new Date(ts.seconds * 1000).toLocaleString('ko-KR', options);
        };

        function renderDashboard() {
            // ... (ì´ì „ê³¼ ë™ì¼)
        }
        
        function createOrderCardHTML(order) {
            // ... (ì´ì „ê³¼ ë™ì¼)
        }

        function renderTabs() {
            const validTabs = config.dayTabs.filter(d => d && typeof d.day === 'number');
            
            const tabsHTML = validTabs.sort((a, b) => a.day - b.day).map(dayInfo => {
                // ... (ì´ì „ê³¼ ë™ì¼)
            }).join('');

            const totalTabHTML = `
                <div class="relative">
                    <button data-day="all" class="tab-btn px-4 py-2 rounded-md font-semibold text-sm bg-white shadow ${viewingDay === 'all' ? 'view-active' : ''}">ğŸ“Š ì „ì²´</button>
                </div>`;
            
            const addDayBtnHTML = `<button id="add-day-btn" class="px-3 py-2 bg-green-500 text-white rounded-md font-bold text-sm hover:bg-green-600 shadow">+</button>`;
            const exportBtnHTML = `<button onclick="showExportModal()" class="px-4 py-2 bg-gray-700 text-white rounded-md font-semibold text-sm hover:bg-gray-800 shadow">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>`;

            dayTabsContainer.innerHTML = totalTabHTML + tabsHTML + addDayBtnHTML + exportBtnHTML;
            
            dayTabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const day = e.currentTarget.dataset.day;
                    viewingDay = day === 'all' ? 'all' : parseInt(day);
                    renderTabs();
                    renderDashboard();
                });
            });
            document.getElementById('add-day-btn').addEventListener('click', async () => {
                // ... (ì´ì „ê³¼ ë™ì¼)
            });
        }

        const modalEl = document.getElementById('modal-container');
        
        function showModal(innerHTML) {
            modalEl.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">${innerHTML}</div>`;
            modalContainer.classList.remove('hidden');
        }
        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }

        // --- ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ ---
        window.showExportModal = () => {
            const isTotalView = viewingDay === 'all';
            const dailyDisabled = isTotalView ? 'disabled' : '';
            const dailyLabelClass = isTotalView ? 'text-gray-400 cursor-not-allowed' : 'cursor-pointer';

            showModal(`
            <div class="bg-white p-8 rounded-xl shadow-2xl text-left w-full max-w-sm">
                <h2 class="text-xl font-bold text-gray-800 mb-6">ì—‘ì…€ë¡œ ë‚´ë³´ë‚¼ ë°ì´í„° ì„ íƒ</h2>
                <div class="space-y-4">
                    <label class="flex items-center ${dailyLabelClass}">
                        <input type="checkbox" id="export-daily-sales" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${dailyDisabled}>
                        <span class="ml-3 text-gray-700">ì¼ì¼ ë§¤ì¶œëŸ‰ (${isTotalView ? 'ì¼ì°¨ ì„ íƒ í•„ìš”' : viewingDay + 'ì¼ì°¨'})</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="export-total-sales" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 text-gray-700">ì „ì²´ ë§¤ì¶œëŸ‰</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="export-orders" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 text-gray-700">ì£¼ë¬¸ ë‚´ì—­ (${isTotalView ? 'ì „ì²´' : viewingDay + 'ì¼ì°¨'})</span>
                    </label>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button onclick="hideModal()" class="px-6 py-2 bg-gray-300 rounded-lg">ì·¨ì†Œ</button>
                    <button onclick="exportToExcel()" class="px-6 py-2 bg-green-600 text-white rounded-lg">ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>`);
        };

        window.exportToExcel = () => {
            const wb = XLSX.utils.book_new();
            let sheetsAdded = 0;

            // 1. ì¼ì¼ ë§¤ì¶œëŸ‰
            if (document.getElementById('export-daily-sales')?.checked) {
                const dailyOrders = allOrders.filter(order => order.festivalDay === viewingDay);
                const { totalRevenue, menuSales } = calculateSales(dailyOrders);
                const data = [['í•­ëª©', 'ìˆ˜ëŸ‰/ê¸ˆì•¡']];
                data.push(['ì´ ë§¤ì¶œ', totalRevenue]);
                Object.entries(menuSales).forEach(([name, qty]) => data.push([name, qty]));
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `${viewingDay}ì¼ì°¨ ë§¤ì¶œ`);
                sheetsAdded++;
            }

            // 2. ì „ì²´ ë§¤ì¶œëŸ‰
            if (document.getElementById('export-total-sales')?.checked) {
                const { totalRevenue, menuSales } = calculateSales(allOrders);
                const data = [['í•­ëª©', 'ìˆ˜ëŸ‰/ê¸ˆì•¡']];
                data.push(['ì´ ë§¤ì¶œ', totalRevenue]);
                Object.entries(menuSales).forEach(([name, qty]) => data.push([name, qty]));
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'ì „ì²´ ë§¤ì¶œ');
                sheetsAdded++;
            }

            // 3. ì£¼ë¬¸ ë‚´ì—­
            if (document.getElementById('export-orders')?.checked) {
                const isTotalView = viewingDay === 'all';
                const ordersToExport = isTotalView ? allOrders : allOrders.filter(order => order.festivalDay === viewingDay);
                const data = ordersToExport.map(order => ({
                    'ì£¼ë¬¸ì‹œê°„': formatTimestamp(order.timestamp, true),
                    'ì¼ì°¨': order.festivalDay,
                    'í…Œì´ë¸”': order.tableNumber,
                    'ì£¼ë¬¸ë²ˆí˜¸': order.orderNumber || '',
                    'ë©”ë‰´': order.items.map(item => `${item.name} x${item.quantity}`).join(', '),
                    'ì´ê¸ˆì•¡': order.totalPrice,
                    'ìƒíƒœ': order.status
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `${isTotalView ? 'ì „ì²´' : viewingDay + 'ì¼ì°¨'} ì£¼ë¬¸ë‚´ì—­`);
                sheetsAdded++;
            }

            if (sheetsAdded > 0) {
                XLSX.writeFile(wb, `festival_data_${new Date().toISOString().split('T')[0]}.xlsx`);
                hideModal();
            } else {
                alert('ë‚´ë³´ë‚¼ í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        };

        function calculateSales(orders) {
            let totalRevenue = 0;
            const menuSales = {};
            orders.forEach(order => {
                totalRevenue += order.totalPrice;
                order.items.forEach(item => { menuSales[item.name] = (menuSales[item.name] || 0) + item.quantity; });
            });
            return { totalRevenue, menuSales };
        }

        // --- ë‚˜ë¨¸ì§€ ì „ì—­ í•¨ìˆ˜ ë° ë¦¬ìŠ¤ë„ˆ ---
        window.showDateModal = (day) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.saveDate = async (day) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.activateDay = async (day) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.showPasswordModal = (day) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.confirmDeleteDay = async (dayToDelete) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.showDeleteModal = (orderId) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.hideModal = hideModal;
        window.confirmDelete = async (orderId) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        window.updateStatus = async (orderId, status) => { /* ì´ì „ê³¼ ë™ì¼ */ };
        onSnapshot(configRef, async (docSnap) => { /* ì´ì „ê³¼ ë™ì¼ */ });
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snapshot) => { /* ì´ì „ê³¼ ë™ì¼ */ });

    </script>
</body>
</html>
