<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 관리 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.view-active { background-color: #4f46e5; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card, .order-card { animation: fadeIn 0.5s ease-in-out; }
        .highlight-new-order {
            border-width: 4px;
            border-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <audio id="new-order-sound" src="https://cwnu-smart.github.io/order_/baedalyi-minjog.mp3" preload="auto"></audio>
    <audio id="additional-order-sound" src="https://cwnu-smart.github.io/order_/baedalyi-minjog.mp3" preload="auto"></audio>
    
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center my-6 relative">
            <h1 class="text-4xl font-bold text-gray-800">주문 관리 대시보드</h1>
            <p class="text-gray-600 mt-2">일자를 선택해 주문을 관리하고, 새 일차를 시작하세요.</p>
            <button id="sound-toggle-btn" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-200 transition"></button>
        </header>

        <div id="day-tabs-container" class="mb-6 flex items-center justify-center flex-wrap gap-3"></div>
        <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6"></section>
        <main id="order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, getDocs, setDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMS_URZ1lFsbyJscsIjPvgENZouSbnX0A",
            authDomain: "order-cfe51.firebaseapp.com",
            projectId: "order-cfe51",
            storageBucket: "order-cfe51.firebasestorage.app",
            messagingSenderId: "1047726700523",
            appId: "1:1047726700523:web:0360158e7baca0d3450bae",
            measurementId: "G-45K52YE0BB"
        };
        
        if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="p-8 text-center bg-white border-4 border-dashed rounded-lg shadow-lg"><h1 class="text-3xl font-bold mb-4 text-red-600">Firebase 설정 오류</h1></div></div>`;
            throw new Error("Firebase configuration is missing.");
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const DELETE_PASSWORD = "1153";
        let allOrders = [], config = { dayTabs: [], activeDay: null }, viewingDay = 'all', previousOrdersMap = new Map(), isMuted = false;
        
        const configRef = doc(db, "festivalConfig", "settings");
        const dayTabsContainer = document.getElementById('day-tabs-container');
        const summarySection = document.getElementById('summary-section');
        const orderList = document.getElementById('order-list');
        const modalContainer = document.getElementById('modal-container');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const newOrderAudio = document.getElementById('new-order-sound');
        const additionalOrderAudio = document.getElementById('additional-order-sound');
        
        const soundOnIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
        const soundOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-2-2m0 0l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

        function toggleSound() { isMuted = !isMuted; soundToggleBtn.innerHTML = isMuted ? soundOffIcon : soundOnIcon; }
        soundToggleBtn.innerHTML = soundOnIcon;
        soundToggleBtn.addEventListener('click', toggleSound);

        const formatTimestamp = (ts) => {
            if (!ts || !ts.seconds) return '시간 정보 없음';
            const date = new Date(ts.seconds * 1000);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const seconds = date.getSeconds();
            return `${year}년 ${month}월 ${day}일 ${hours}시 ${minutes}분 ${seconds}초`;
        };

        function renderDashboard() {
            const ordersToDisplay = viewingDay === 'all' ? allOrders : allOrders.filter(o => o.festivalDay === viewingDay);
            const { totalRevenue, menuSales } = calculateSales(ordersToDisplay);
            summarySection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                    <h2 class="text-xl font-bold text-gray-700 mb-2">${viewingDay === 'all' ? '전체 총 매출' : '일일 총 매출'}</h2>
                    <p class="text-4xl font-extrabold text-indigo-600">${totalRevenue.toLocaleString()}원</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                    <h2 class="text-xl font-bold text-gray-700 mb-2">${viewingDay === 'all' ? '전체 메뉴별 판매량' : '일일 메뉴별 판매량'}</h2>
                    <div class="space-y-2 text-gray-800">${Object.keys(menuSales).length > 0 ? Object.entries(menuSales).sort(([,a],[,b]) => b-a).map(([name, q]) => `<p class="flex justify-between font-medium"><span>${name}</span><span>${q}개</span></p>`).join('') : '<p class="text-gray-500">주문 내역이 없습니다.</p>'}</div>
                </div>`;
            orderList.innerHTML = '';
            const statusPriority = { "주문 접수 중": 1, "요리 중": 2, "서빙 완료": 3, "처리 완료": 4 };
            ordersToDisplay.sort((a, b) => (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99) || b.timestamp.seconds - a.timestamp.seconds);
            ordersToDisplay.forEach(order => {
                const card = document.createElement('div');
                card.innerHTML = createOrderCardHTML(order).trim();
                orderList.appendChild(card.firstChild);
            });
        }
        
        function createOrderCardHTML(order) {
            const statusStyles = { "주문 접수 중": "border-yellow-400", "요리 중": "border-blue-400", "서빙 완료": "border-green-400", "처리 완료": "border-gray-300" };
            const statusBtnStyles = { "주문 접수 중": "bg-yellow-100 text-yellow-800", "요리 중": "bg-blue-100 text-blue-800", "서빙 완료": "bg-green-100 text-green-800", "처리 완료": "bg-gray-200 text-gray-500" };
            const highlightClass = order.isHighlighted ? 'highlight-new-order' : (statusStyles[order.status] || '');
            const batchesHTML = (order.orderBatches || [{items: order.items || []}]).map((batch, index) => {
                const itemsHTML = (batch.items || []).map(item => {
                    const textColor = !batch.acknowledged ? 'text-red-500 font-bold' : 'text-gray-700';
                    const displayText = `${item.name} x${item.quantity}`;
                    return `<p class="${textColor}">${displayText}</p>`;
                }).join('');
                return (index > 0 ? '<hr class="my-2 border-dashed border-gray-300">' : '') + itemsHTML;
            }).join('');
            return `<div data-order-id="${order.id}" class="bg-white rounded-xl shadow-lg p-5 flex flex-col transition-all duration-300 relative order-card border-4 ${highlightClass} ${order.status === '처리 완료' ? 'opacity-60' : ''}">
                <div class="flex justify-between items-start mb-3">
                    <h2 class="text-2xl font-bold text-indigo-600 pr-4">테이블 ${order.tableNumber}</h2>
                    <div class="text-right flex-shrink-0">
                        <button data-action="showDeleteModal" data-id="${order.id}" class="text-gray-400 hover:text-red-600 z-10 block ml-auto w-6 h-6"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                        <span class="order-time text-xs text-gray-500">${formatTimestamp(order.timestamp)}</span>
                    </div>
                </div>
                <div class="border-t border-b border-gray-200 py-3 my-3 space-y-2 flex-grow">${batchesHTML}</div>
                <div class="text-right mb-4"><span class="text-lg font-semibold">총 금액: </span><span class="text-xl font-bold text-gray-900">${order.totalPrice.toLocaleString()}원</span></div>
                <div class="grid grid-cols-2 gap-2 text-sm">${Object.keys(statusBtnStyles).map(status => `<button data-action="updateStatus" data-id="${order.id}" data-status="${status}" class="p-2 rounded-md font-semibold ${status === order.status ? statusBtnStyles[status] : 'bg-gray-200 hover:bg-gray-300'}">${status}</button>`).join('')}</div>
            </div>`;
        }
        
        function renderTabs(){const t=(config.dayTabs||[]).filter(e=>e&&typeof e.day=="number"),e=t.sort((t,e)=>t.day-e.day).map(t=>`
        <div class="relative group"><button data-day="${t.day}" class="tab-btn px-4 py-2 rounded-md font-semibold text-sm bg-white shadow w-full text-left ${t.day===viewingDay?"view-active":""}">${t.day}일차</button><div class="absolute top-full pt-1 left-1/2 -translate-x-1/2 z-20 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-300"><div class="flex items-center bg-white shadow-xl rounded-md p-1"><button data-action="activateDay" data-day="${t.day}" title="활성화" class="p-2 text-gray-500 hover:text-emerald-500"><svg class="pointer-events-none h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></button><button data-action="showDateModal" data-day="${t.day}" title="날짜 수정" class="p-2 text-gray-500 hover:text-indigo-600"><svg class="pointer-events-none h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/></svg></button><button data-action="showPasswordModal" data-day="${t.day}" title="삭제" class="p-2 text-gray-500 hover:text-red-600"><svg class="pointer-events-none h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg></button></div></div>
        ${t.day===config.activeDay?'<span class="absolute -top-2 -right-2 text-xs bg-emerald-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">ON</span>':""}</div>`).join("");dayTabsContainer.innerHTML=`<button data-day="all" class="tab-btn px-4 py-2 rounded-md font-semibold text-sm bg-white shadow ${"all"===viewingDay?"view-active":""}">📊 전체</button>`+e+'<button id="add-day-btn" class="px-3 py-2 bg-green-500 text-white rounded-md font-bold text-sm hover:bg-green-600 shadow">+</button><button id="export-btn" class="px-4 py-2 bg-gray-700 text-white rounded-md font-semibold text-sm hover:bg-gray-800 shadow">엑셀</button>`}
        function showModal(t){modalContainer.innerHTML=`<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">${t}</div>`;modalContainer.classList.remove("hidden")}
        function hideModal(){modalContainer.classList.add("hidden");modalContainer.innerHTML=""}

        const appFunctions={showDateModal:t=>{const e=config.dayTabs.find(e=>e.day===t);showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm"><h2 class="text-xl font-bold mb-4">${t}일차 날짜 설정</h2><input id="date-input" type="date" value="${e.date||""}" class="w-full p-2 border rounded-md mb-4"><div class="flex justify-center space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">취소</button><button id="save-date-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">저장</button></div></div>`);document.getElementById("save-date-btn").onclick=()=>appFunctions.saveDate(t)},saveDate:async t=>{const e=document.getElementById("date-input").value;if(!e)return void alert("날짜를 선택해주세요.");const a=config.dayTabs.map(a=>a.day===t?{...a,date:e}:a);await setDoc(configRef,{dayTabs:a},{merge:!0});hideModal()},activateDay:async t=>{const e=config.dayTabs.find(e=>e.day===t);if(!e||!e.date)return void alert("날짜를 먼저 저장해주세요.");confirm(`${t}일차(${e.date})를 활성화하시겠습니까?`)&&await setDoc(configRef,{activeDay:t},{merge:!0})},showPasswordModal:t=>{showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm"><h2 class="text-xl font-bold text-red-600 mb-4">${t}일차 삭제</h2><p class="mb-4">비밀번호를 입력하세요.</p><input id="password-input" type="password" class="w-full p-2 border rounded-md mb-4"><div class="flex justify-center space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">취소</button><button id="confirm-delete-day-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg">삭제</button></div></div>`);document.getElementById("confirm-delete-day-btn").onclick=()=>appFunctions.confirmDeleteDay(t)},confirmDeleteDay:async t=>{if(document.getElementById("password-input").value!==DELETE_PASSWORD)return void alert("비밀번호가 틀렸습니다.");if(!confirm(`정말로 ${t}일차 데이터를 영구적으로 삭제하시겠습니까?`))return;try{const e=writeBatch(db),a=query(collection(db,"orders"),where("festivalDay","==",t)),o=await getDocs(a);o.forEach(t=>e.delete(t.ref));const n=config.dayTabs.filter(e=>e.day!==t);e.set(configRef,{dayTabs:n},{merge:!0});await e.commit();hideModal()}catch(t){console.error("삭제 오류:",t);alert("삭제 중 오류 발생")}},showDeleteModal:t=>{showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm"><h2 class="text-xl font-bold text-red-600 mb-4">주문을 삭제하시겠습니까?</h2><div class="flex justify-center space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">취소</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg">삭제</button></div></div>`);document.getElementById("confirm-delete-btn").onclick=()=>appFunctions.confirmDelete(t)},confirmDelete:async t=>{await deleteDoc(doc(db,"orders",t));hideModal()},updateStatus:async(t,e)=>{const a=doc(db,"orders",t),o=await getDoc(a);if(o.exists()){const t=(o.data().orderBatches||[]).map(t=>({...t,acknowledged:!0}));await updateDoc(a,{status:e,isHighlighted:!1,orderBatches:t})}},showExportModal:()=>{const t="all"===viewingDay;showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-left w-full max-w-sm"><h2 class="text-xl font-bold mb-6">엑셀 데이터 선택</h2><div class="space-y-4"><label class="flex items-center ${t?"text-gray-400":""}"><input type="checkbox" id="export-daily-sales" class="h-5 w-5" ${t?"disabled":""}><span class="ml-3">일일 매출 (${t?"일차 선택 필요":viewingDay+"일차"})</span></label><label class="flex items-center"><input type="checkbox" id="export-total-sales" class="h-5 w-5"><span class="ml-3">전체 매출</span></label><label class="flex items-center"><input type="checkbox" id="export-orders" class="h-5 w-5"><span class="ml-3">주문 내역 (${t?"전체":viewingDay+"일차"})</span></label></div><div class="mt-8 flex justify-end space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">취소</button><button id="confirm-export-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg">다운로드</button></div></div>`);document.getElementById("confirm-export-btn").onclick=appFunctions.exportToExcel},exportToExcel:()=>{const t=XLSX.utils.book_new();if(document.getElementById("export-daily-sales")?.checked){const{totalRevenue:e,menuSales:a}=calculateSales(allOrders.filter(t=>t.festivalDay===viewingDay));XLSX.utils.book_append_sheet(t,XLSX.utils.aoa_to_sheet([["항목","값"],["총 매출",e],...Object.entries(a)]),`${viewingDay}일차 매출`)}
            if(document.getElementById("export-total-sales")?.checked){const{totalRevenue:e,menuSales:a}=calculateSales(allOrders);XLSX.utils.book_append_sheet(t,XLSX.utils.aoa_to_sheet([["항목","값"],["총 매출",e],...Object.entries(a)]),"전체 매출")}
            if(document.getElementById("export-orders")?.checked){const e="all"===viewingDay?allOrders:allOrders.filter(t=>t.festivalDay===viewingDay),a=e.map(t=>({시간:formatTimestamp(t.timestamp),일차:t.festivalDay,테이블:t.tableNumber,메뉴:(t.orderBatches||[]).flatMap(t=>t.items).map(t=>`${t.name}x${t.quantity}`).join(", "),금액:t.totalPrice,상태:t.status}));XLSX.utils.book_append_sheet(t,XLSX.utils.json_to_sheet(a),"주문내역")}
            t.SheetNames.length>0?XLSX.writeFile(t,"매출정산.xlsx"):alert("항목을 선택해주세요.");hideModal()},hideModal:hideModal};
        
        function calculateSales(orders) {
            const menuSales = {};
            const allItems = orders.flatMap(o => (o.orderBatches || [{ items: o.items || [] }]).flatMap(b => b.items || []));
            allItems.forEach(item => {
                if (item && item.name && typeof item.quantity === 'number') {
                    menuSales[item.name] = (menuSales[item.name] || 0) + item.quantity;
                }
            });
            const totalRevenue = orders.reduce((sum, o) => sum + (o.totalPrice || 0), 0);
            return { totalRevenue, menuSales };
        }

        document.body.addEventListener('click', e => {
            const target = e.target.closest('[data-action], #add-day-btn, #export-btn, .tab-btn');
            if (!target) return;
            const { action, day, id, status } = target.dataset;
            if (action && appFunctions[action]) {
                appFunctions[action](id || (day ? parseInt(day) : null), status);
            } else if (target.id === 'add-day-btn') {
                const nextDay = (config.dayTabs?.length || 0) + 1;
                setDoc(configRef, { dayTabs: [...(config.dayTabs || []), { day: nextDay, date: null }] }, { merge: true });
            } else if (target.id === 'export-btn') {
                appFunctions.showExportModal();
            } else if (target.matches('.tab-btn')) {
                viewingDay = target.dataset.day === 'all' ? 'all' : parseInt(target.dataset.day);
                renderTabs(); renderDashboard();
            }
        });

        onSnapshot(configRef, (docSnap) => {
            config = docSnap.exists() ? { dayTabs: [], ...docSnap.data() } : { dayTabs: [{ day: 1, date: new Date().toISOString().split('T')[0] }], activeDay: 1 };
            if (viewingDay !== 'all' && !(config.dayTabs || []).some(d => d.day === viewingDay)) {
                viewingDay = config.activeDay || 'all';
            }
            renderTabs(); renderDashboard();
        });

        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snapshot) => {
            const newOrdersMap = new Map(snapshot.docs.map(doc => [doc.id, { id: doc.id, ...doc.data() }]));
            if (previousOrdersMap.size > 0 && !isMuted) {
                newOrdersMap.forEach((order, id) => {
                    const prevOrder = previousOrdersMap.get(id);
                    if (order.isHighlighted && (!prevOrder || !prevOrder.isHighlighted)) {
                        const isAdditionalOrder = prevOrder && (prevOrder.orderBatches?.length || 1) < (order.orderBatches?.length || 1);
                        if (isAdditionalOrder) {
                            additionalOrderAudio.play().catch(e=>console.log("추가 주문 알림음 재생 실패:", e));
                        } else {
                            newOrderAudio.play().catch(e=>console.log("신규 주문 알림음 재생 실패:", e));
                        }
                    }
                });
            }
            allOrders = Array.from(newOrdersMap.values());
            previousOrdersMap = new Map(newOrdersMap);
            renderDashboard();
        });
    </script>
</body>
</html>
