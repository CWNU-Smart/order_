<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.view-active { background-color: #4f46e5; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card, .order-card { animation: fadeIn 0.5s ease-in-out; }
        .highlight-new-order {
            border-width: 4px;
            border-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <audio id="new-order-sound" src="https://github.com/CWNU-Smart/order_/raw/refs/heads/main/ta-da_yrvBrlS.mp3" preload="auto"></audio>
Â  Â  <audio id="additional-order-sound" src="https://github.com/CWNU-Smart/order_/raw/refs/heads/main/ta-da_yrvBrlS.mp3" preload="auto"></audio>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center my-6 relative">
            <h1 class="text-4xl font-bold text-gray-800">ì£¼ë¬¸ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-600 mt-2">ì¼ìë¥¼ ì„ íƒí•´ ì£¼ë¬¸ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            <button id="sound-toggle-btn" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-200 transition"></button>
        </header>

        <div id="day-tabs-container" class="mb-6 flex items-center justify-center flex-wrap gap-3"></div>
        <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6"></section>
        <main id="order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMS_URZ1lFsbyJscsIjPvgENZouSbnX0A",
            authDomain: "order-cfe51.firebaseapp.com",
            projectId: "order-cfe51",
            storageBucket: "order-cfe51.firebasestorage.app",
            messagingSenderId: "1047726700523",
            appId: "1:1047726700523:web:0360158e7baca0d3450bae",
            measurementId: "G-45K52YE0BB"
        };

        if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            document.body.innerHTML = `<div class="p-8 text-center bg-white"><h1 class="text-3xl font-bold text-red-600">Firebase ì„¤ì • ì˜¤ë¥˜</h1></div>`;
            throw new Error("Firebase configuration is missing.");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DELETE_PASSWORD = "11531153"; 

        let allOrders = [];
        let config = { dayTabs: [], activeDay: null };
        let viewingDay = 'all';
        let previousOrdersMap = new Map();
        let isMuted = false;

        const configRef = doc(db, "festivalConfig", "settings");
        const dayTabsContainer = document.getElementById('day-tabs-container');
        const summarySection = document.getElementById('summary-section');
        const orderList = document.getElementById('order-list');
        const modalContainer = document.getElementById('modal-container');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const newOrderAudio = document.getElementById('new-order-sound');
        const additionalOrderAudio = document.getElementById('additional-order-sound');

        const soundOnIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
        const soundOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-2-2m0 0l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

        function toggleSound() {
            isMuted = !isMuted;
            soundToggleBtn.innerHTML = isMuted ? soundOffIcon : soundOnIcon;
        }
        soundToggleBtn.innerHTML = soundOnIcon;
        soundToggleBtn.addEventListener('click', toggleSound);

        const formatTimestamp = (ts) => {
            if (!ts || !ts.seconds) return '';
            const date = new Date(ts.seconds * 1000);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}ì‹œ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        };

        function renderDashboard() {
            const isTotalView = viewingDay === 'all';
            const ordersToDisplay = isTotalView ? allOrders : allOrders.filter(order => order.festivalDay === viewingDay);

            let totalRevenue = 0;
            const menuSales = {};
            ordersToDisplay.forEach(order => { totalRevenue += order.totalPrice; });

            const allItems = ordersToDisplay.flatMap(order => (order.orderBatches || []).flatMap(batch => batch.items));
            allItems.forEach(item => {
                // ìˆ˜ëŸ‰ì´ ì—†ëŠ” ê²½ìš°(ì˜¤ë¥˜ ë°ì´í„°)ë¥¼ ëŒ€ë¹„í•´ ê¸°ë³¸ê°’ 1ë¡œ ì„¤ì •
                const quantity = item.quantity || 1;
                menuSales[item.name] = (menuSales[item.name] || 0) + quantity;
            });

            summarySection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                    <h2 class="text-xl font-bold text-gray-700 mb-2">${isTotalView ? 'ì „ì²´ ì´ ë§¤ì¶œ' : 'ì¼ì¼ ì´ ë§¤ì¶œ'}</h2>
                    <p class="text-4xl font-extrabold text-indigo-600">${totalRevenue.toLocaleString()}ì›</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                    <h2 class="text-xl font-bold text-gray-700 mb-2">${isTotalView ? 'ì „ì²´ ë©”ë‰´ë³„ íŒë§¤ëŸ‰' : 'ì¼ì¼ ë©”ë‰´ë³„ íŒë§¤ëŸ‰'}</h2>
                    <div class="space-y-2 text-gray-800">${Object.keys(menuSales).length > 0 ? Object.entries(menuSales).sort(([,a],[,b]) => b-a).map(([name, q]) => `<p class="flex justify-between font-medium"><span>${name}</span><span>${q}ê°œ</span></p>`).join('') : '<p class="text-gray-500">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}</div>
                </div>`;

            orderList.innerHTML = '';
            const statusPriority = { "ì£¼ë¬¸ ì ‘ìˆ˜ ì¤‘": 1, "ìš”ë¦¬ ì¤‘": 2, "ì„œë¹™ ì™„ë£Œ": 3, "ì²˜ë¦¬ ì™„ë£Œ": 4 };
            ordersToDisplay.sort((a, b) => (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99) || b.timestamp.seconds - a.timestamp.seconds);
            ordersToDisplay.forEach(order => {
                const cardWrapper = document.createElement('div');
                cardWrapper.innerHTML = createOrderCardHTML(order).trim();
                orderList.appendChild(cardWrapper.firstChild);
            });
        }

        // âœ…âœ…âœ… ì´ í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ ì¹´ìš´íŠ¸ê°€ ëª…í™•íˆ ë³´ì´ë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. âœ…âœ…âœ…
        function createOrderCardHTML(order) {
    const statusStyles = { "ì£¼ë¬¸ ì ‘ìˆ˜ ì¤‘": "border-yellow-400", "ìš”ë¦¬ ì¤‘": "border-blue-400", "ì„œë¹™ ì™„ë£Œ": "border-green-400", "ì²˜ë¦¬ ì™„ë£Œ": "border-gray-300" };
    const statusBtnStyles = { "ì£¼ë¬¸ ì ‘ìˆ˜ ì¤‘": "bg-yellow-100 text-yellow-800", "ìš”ë¦¬ ì¤‘": "bg-blue-100 text-blue-800", "ì„œë¹™ ì™„ë£Œ": "bg-green-100 text-green-800", "ì²˜ë¦¬ ì™„ë£Œ": "bg-gray-200 text-gray-500" };
    const highlightClass = order.isHighlighted ? 'highlight-new-order' : (statusStyles[order.status] || '');

    // ìƒíƒœ ë³€ê²½ ê¸°ë¡
    const history = order.statusHistory || [];
    const lastRecord = history.length > 0 ? history[history.length - 1] : null;
    const lastTime = lastRecord ? new Date(lastRecord.time).toLocaleString("ko-KR") : formatTimestamp(order.timestamp);

    const historyText = history.map(h => `${h.status} - ${new Date(h.time).toLocaleString("ko-KR")}`).join("\n");

    const batchesHTML = (order.orderBatches || []).map((batch, index) => {
        const itemsHTML = (batch.items || []).map(item => {
            const textColor = !batch.acknowledged ? 'text-red-500 font-bold' : 'text-gray-700';
            const quantityText = `x${item.quantity || 1}`;
            return `<p class="flex justify-between ${textColor}">
                        <span>${item.name} ${quantityText}</span>
                    </p>`;
        }).join('');
        const separator = index > 0 ? '<hr class="my-2 border-dashed border-gray-400">' : '';
        return separator + itemsHTML;
    }).join('');

    return `
    <div data-order-id="${order.id}" class="bg-white rounded-xl shadow-lg p-5 flex flex-col transition-all duration-300 relative order-card border-4 ${highlightClass} ${order.status === 'ì²˜ë¦¬ ì™„ë£Œ' ? 'opacity-60' : ''}">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-2xl font-bold text-indigo-500 pr-4">í…Œì´ë¸” <span class="table-number">${order.tableNumber}</span></h2>
            <div class="text-right flex-shrink-0" title="${historyText}">
                <button data-action="showDeleteModal" data-id="${order.id}" class="text-gray-400 hover:text-red-600 z-10 block ml-auto w-6 h-6">
                    <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <span class="order-time text-xs text-gray-500 block mt-1">${lastTime}</span>
            </div>
        </div>
        <div class="order-items border-t border-b border-gray-200 py-3 my-3 space-y-2 text-gray-700 flex-grow">${batchesHTML}</div>
        <div class="text-right mb-4"><span class="text-lg font-semibold">ì´ ê¸ˆì•¡: </span><span class="total-price text-xl font-bold text-gray-900">${order.totalPrice.toLocaleString()}ì›</span></div>
        <div class="status-btn-group grid grid-cols-2 gap-2 text-sm">${Object.keys(statusBtnStyles).map(status => `<button data-action="updateStatus" data-id="${order.id}" data-status="${status}" class="p-2 rounded-md font-semibold ${status === order.status ? statusBtnStyles[status] : 'bg-gray-200 hover:bg-gray-300'}">${status}</button>`).join('')}</div>
    </div>`;
}


        // ì´í•˜ ì½”ë“œëŠ” ìƒëµ ì—†ì´ ë™ì¼í•©ë‹ˆë‹¤.

        function renderTabs() {
            const validTabs = (config.dayTabs || []).filter(d => d && typeof d.day === 'number');
            const tabsHTML = validTabs.sort((a, b) => a.day - b.day).map(dayInfo => `
                <div class="relative group">
                    <button data-day="${dayInfo.day}" class="tab-btn px-4 py-2 rounded-md font-semibold text-sm bg-white shadow w-full text-left ${dayInfo.day === viewingDay ? 'view-active' : ''}">
                        ${dayInfo.day}ì¼ì°¨
                    </button>
                    <div class="absolute top-full pt-1 left-1/2 -translate-x-1/2 z-20 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-300">
                        <div class="flex items-center bg-white shadow-xl rounded-md p-1">
                            <button data-action="activateDay" data-day="${dayInfo.day}" title="í™œì„±í™”" class="p-2 text-gray-500 hover:text-emerald-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></button>
                            <button data-action="showDateModal" data-day="${dayInfo.day}" title="ë‚ ì§œ ìˆ˜ì •" class="p-2 text-gray-500 hover:text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button data-action="showPasswordModal" data-day="${dayInfo.day}" title="ì‚­ì œ" class="p-2 text-gray-500 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    ${dayInfo.day === config.activeDay ? '<span class="absolute -top-2 -right-2 text-xs bg-emerald-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">ON</span>' : ''}
                </div>`
            ).join('');
            const totalTabHTML = `<div class="relative"><button data-day="all" class="tab-btn px-4 py-2 rounded-md font-semibold text-sm bg-white shadow ${viewingDay === 'all' ? 'view-active' : ''}">ğŸ“Š ì „ì²´</button></div>`;
            const addDayBtnHTML = `<button id="add-day-btn" class="px-3 py-2 bg-green-500 text-white rounded-md font-bold text-sm hover:bg-green-600 shadow">+</button>`;
            const exportBtnHTML = `<button id="export-btn" class="px-4 py-2 bg-gray-700 text-white rounded-md font-semibold text-sm hover:bg-gray-800 shadow">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>`;
            dayTabsContainer.innerHTML = totalTabHTML + tabsHTML + addDayBtnHTML + exportBtnHTML;
        }

        function showModal(innerHTML) {
            modalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">${innerHTML}</div>`;
            modalContainer.classList.remove('hidden');
        }
        function hideModal() { modalContainer.classList.add('hidden'); modalContainer.innerHTML = ''; }

        const appFunctions = {
            showDateModal: (day) => {
                const dayInfo = config.dayTabs.find(d => d.day === day);
                showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm"><h2 class="text-xl font-bold text-gray-800 mb-4">${day}ì¼ì°¨ ë‚ ì§œ ì„¤ì •</h2><input id="date-input" type="date" value="${dayInfo.date || ''}" class="w-full p-2 border rounded-md mb-4"><div class="flex justify-center space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">ì·¨ì†Œ</button><button id="save-date-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">ì €ì¥</button></div></div>`);
                document.getElementById('save-date-btn').onclick = () => appFunctions.saveDate(day);
            },
            saveDate: async (day) => {
                const newDate = document.getElementById('date-input').value;
                if (!newDate) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const updatedDayTabs = config.dayTabs.map(d => d.day === day ? { ...d, date: newDate } : d);
                await setDoc(configRef, { dayTabs: updatedDayTabs }, { merge: true });
                hideModal();
            },
            activateDay: async (day) => {
                const dayInfo = config.dayTabs.find(d => d.day === day);
                if (!dayInfo || !dayInfo.date) { alert('ë‚ ì§œê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ì¼ì°¨ëŠ” í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
                if (confirm(`${day}ì¼ì°¨(${dayInfo.date})ë¥¼ ì£¼ë¬¸ ìˆ˜ì§‘ì¼ë¡œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    await setDoc(configRef, { activeDay: day }, { merge: true });
                }
            },
            showPasswordModal: (day) => {
                showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm"><h2 class="text-xl font-bold text-red-600 mb-4">${day}ì¼ì°¨ ì‚­ì œ</h2><p class="text-gray-600 mb-4">ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. í•´ë‹¹ ì¼ì°¨ì˜ ëª¨ë“  ì£¼ë¬¸ ë‚´ì—­ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p><input id="password-input" type="password" class="w-full p-2 border rounded-md mb-4" placeholder="ë¹„ë°€ë²ˆí˜¸"><div class="flex justify-center space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">ì·¨ì†Œ</button><button id="confirm-delete-day-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg">ì‚­ì œ í™•ì¸</button></div></div>`);
                document.getElementById('confirm-delete-day-btn').onclick = () => appFunctions.confirmDeleteDay(day);
            },
            confirmDeleteDay: async (dayToDelete) => {
                const password = document.getElementById('password-input').value;
                if (password !== DELETE_PASSWORD) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }
                if (!confirm(`ì •ë§ë¡œ ${dayToDelete}ì¼ì°¨ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
                try {
                    const batch = writeBatch(db);
                    const ordersToDeleteQuery = query(collection(db, "orders"), where("festivalDay", "==", dayToDelete));
                    const ordersToDeleteSnapshot = await getDocs(ordersToDeleteQuery);
                    ordersToDeleteSnapshot.forEach(doc => batch.delete(doc.ref));
                    const updatedTabs = config.dayTabs.filter(d => d.day !== dayToDelete);
                    batch.set(configRef, { dayTabs: updatedTabs, activeDay: config.activeDay === dayToDelete ? null : config.activeDay }, { merge: true });
                    await batch.commit();
                    hideModal();
                    alert(`${dayToDelete}ì¼ì°¨ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) { console.error("ì¼ì°¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error); alert("ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            },
            showDeleteModal: (orderId) => {
                showModal(`<div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-sm"><h2 class="text-xl font-bold text-red-600 mb-4">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2><p class="text-gray-700 mb-6">ì´ ì£¼ë¬¸ ë‚´ì—­ì€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p><div class="flex justify-center space-x-4"><button data-action="hideModal" class="px-6 py-2 bg-gray-300 rounded-lg">ì·¨ì†Œ</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg">ì‚­ì œ</button></div></div>`);
                document.getElementById('confirm-delete-btn').onclick = () => appFunctions.confirmDelete(orderId);
            },
            confirmDelete: async (orderId) => { await deleteDoc(doc(db, "orders", orderId)); hideModal(); },
            updateStatus: async (orderId, status) => {
    const orderRef = doc(db, "orders", orderId);
    const orderSnap = await getDoc(orderRef);
    let statusHistory = [];

    if(orderSnap.exists()) {
        const data = orderSnap.data();
        statusHistory = data.statusHistory || [];
        statusHistory.push({
            status,
            time: new Date().toISOString()
        });

        const updateData = { 
            status: status, 
            isHighlighted: false, 
            statusHistory 
        };

        // 'ì£¼ë¬¸ ì ‘ìˆ˜ ì¤‘'ì´ ì•„ë‹Œ ê²½ìš°ì—ëŠ” ë°°ì¹˜ë„ í™•ì¸ ì²˜ë¦¬
        if(status !== 'ì£¼ë¬¸ ì ‘ìˆ˜ ì¤‘') {
            const updatedBatches = (data.orderBatches || []).map(batch => ({
                ...batch, 
                acknowledged: true 
            }));
            updateData.orderBatches = updatedBatches;
        }
        await updateDoc(orderRef, updateData);
    }
},
            hideModal: hideModal
        };

        document.body.addEventListener('click', e => {
            let target = e.target;
            while(target && !target.dataset.action && target.id !== 'add-day-btn' && target.id !== 'export-btn' && !target.matches('.tab-btn')) { target = target.parentElement; }
            if(!target) return;
            const action = target.dataset.action;
            if (action && appFunctions[action]) {
                const day = target.dataset.day ? parseInt(target.dataset.day) : null;
                const id = target.dataset.id;
                const status = target.dataset.status;
                if (day !== null && !isNaN(day)) appFunctions[action](day);
                else if (id && status) appFunctions[action](id, status);
                else if (id) appFunctions[action](id);
                else appFunctions[action]();
            } else if (target.id === 'add-day-btn') {
                const dayNumbers = (config.dayTabs || []).map(d => d.day).filter(d => !isNaN(d));
                const nextDay = dayNumbers.length > 0 ? Math.max(0, ...dayNumbers) + 1 : 1;
                setDoc(configRef, { dayTabs: [...(config.dayTabs || []), { day: nextDay, date: null }] }, { merge: true });
            } else if (target.id === 'export-btn') {
                // Export function can be added here if needed
            } else if (target.matches('.tab-btn')) {
                const day = target.dataset.day;
                viewingDay = day === 'all' ? 'all' : parseInt(day);
                renderTabs();
                renderDashboard();
            }
        });

Â  Â  Â  Â  onSnapshot(query(collection(db, "orders")), (snapshot) => {
Â  Â  Â  Â  Â  Â  const newOrdersMap = new Map();
Â  Â  Â  Â  Â  Â  snapshot.docs.forEach(doc => newOrdersMap.set(doc.id, { id: doc.id, ...doc.data() }));

Â  Â  Â  Â  Â  Â  // âœ… ëª¨ë“  ì£¼ë¬¸ ì—…ë°ì´íŠ¸/ì¶”ê°€ ì‹œ ì†Œë¦¬ ì¬ìƒ ë¡œì§ (ìˆ˜ì •ëœ ë¶€ë¶„)
Â  Â  Â  Â  Â  Â  if (previousOrdersMap.size > 0 && !isMuted) {
Â  Â  Â  Â  Â  Â  Â  Â  let shouldPlaySound = false;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 1. ìƒˆë¡œìš´ ì£¼ë¬¸ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
Â  Â  Â  Â  Â  Â  Â  Â  if (newOrdersMap.size > previousOrdersMap.size) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shouldPlaySound = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. ê¸°ì¡´ ì£¼ë¬¸ ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newOrdersMap.forEach((order, id) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prevOrder = previousOrdersMap.get(id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì£¼ë¬¸ IDê°€ ì¡´ì¬í•˜ê³ , ë‘ ì£¼ë¬¸ ê°ì²´ê°€ ë‹¤ë¥¼ ê²½ìš° (ìƒíƒœ ë³€ê²½, isHighlighted ë³€ê²½, í•­ëª© ì¶”ê°€ ë“±)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // JSON.stringifyë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ë¹„êµ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (prevOrder && JSON.stringify(prevOrder) !== JSON.stringify(order)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shouldPlaySound = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (shouldPlaySound) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (additionalOrderAudio.cloneNode(true)).play().catch(e=>console.error(e));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
            // âš ï¸ ì£¼ì˜: ì´ì „ ë¡œì§ì—ì„œ 'isHighlighted' ìƒíƒœë¥¼ ë¦¬ì…‹í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, 
            // isHighlightedê°€ trueì¼ ê²½ìš° ìƒíƒœ ë³€ê²½ì´ ì—†ì–´ë„ ë§¤ë²ˆ ì†Œë¦¬ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
            // ì´ëŠ” í˜„ì¬ 'ëª¨ë“  ì¡°ê±´ì— ìƒê´€ì—†ì´ ë¬´ì¡°ê±´ ì£¼ë¬¸í•˜ë©´' ì´ë¼ëŠ” ìš”ì²­ì— ë¶€í•©í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  allOrders = Array.from(newOrdersMap.values());
Â  Â  Â  Â  Â  Â  previousOrdersMap = new Map(newOrdersMap);
Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  });
    </script>
</body>
</html>


